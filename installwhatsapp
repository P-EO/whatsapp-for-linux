#!/bin/bash

#Identifying the system package manager

if [ -e /usr/bin/apt ]; then
packagemanager=apt
if [ -e /usr/bin/dnf ]; then
packagemanager=dnf
if [ -e /usr/bin/yum ]; then
packagemanager=yum

if [ -e $packagemanager ]; then
    echo -e "\e[32mPackage manager: ${osInfo[$f]}\e[0m" 
else 
    echo "Package manager not found.";
    	exit 1
fi

#Updating package list
if $packagemanager=apt; then
    sudo apt update 
elif $packagemanager=yum; then
    sudo yum check-update
elif $packagemanager=dnf; then
    sudo dnf check-update
fi

#Download prerequisites to nativefy WhatsApp

#Checking if Nodejs is installed 
if [ -e /usr/bin/nodejs ]; then
    nodejsversion=$(nodejs -v | tr -dc '0-9, .') 
	nodejsversion2=$(nodejs -v | tr -dc '0-9, .'| head -c 2)
fi

if (($nodejsversion2>=13)) ; then
		echo -e "\e[32mNodejs is installed, version is `nodejs -v`, compatible with Nativefier\e[0m"
elif (($nodejsversion2<13)) ; then
        echo -e "\e[32mNodejs is installed, version is `nodejs -v`, not compatible with Nativefier, updating...\e[0m"       
           if packagemanager=apt; then 
                curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash - 
           else 
                curl -fsSL https://rpm.nodesource.com/setup_16.x | sudo bash -
           fi
else 
        echo -e "\e[32mNodejs is not installed, installing it for you... \e[0m"
            if packagemanager=apt; then 
                curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -
            else 
                curl -fsSL https://rpm.nodesource.com/setup_16.x | sudo bash -
            fi
fi



npm install -g nativefier
sudo mkdir WhatsApp
cd Whatsapp
wget https://raw.githubusercontent.com/ITdairy/whatsapp-nativefier-script/main/run-whatsapp.sh
wget https://raw.githubusercontent.com/ITdairy/whatsapp-nativefier-script/main/whatsapp.desktop
 
#Nativefier WhatsApp with user agent
echo -e '\e[32mNativefying WhatsApp from http://web.whatsapp.com ...\e[39m'
nativefier https://web.whatsapp.com --user-agent "Mozilla/5.0 (X11; CrOS armv7l 13597.84.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.187 Safari/537.36" -a `uname -m` --maximize -n WhatsApp
cd ./WhatsApp-linux-`uname -m`
sudo cp ../run-whatsapp.sh ./
sudo chmod +x ./run-whatsapp.sh
cd ..
echo -e '\e[32mDone installing WhatsApp, Creating desktop shortcut and menu shortcut...'

#Create desktop & menu shortcut
sudo cp ./whatsapp.desktop /usr/share/applications
sudo cp ./whatsapp.desktop ~/Desktop
echo -e '\e[32mDone! You can now run WhatsApp from desktop and menu bar.\e[39m'
echo -e "\e[101mPlease let me know if you can't see desktop shortcut and menu bar shortcut!\e[0m"
cd ~/

